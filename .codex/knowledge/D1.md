# D1 — Legal adapter 0.2 (SQLite) — knowledge

## What tightened (this pass)
- **Engine & build**: Hermetic **sql.js (WASM)** DB built from `fixtures/schema.sql` + `fixtures/seed.sql`; no binary DBs tracked (`.gitignore` guards).
- **Determinism**: All user-visible queries specify **ORDER BY**; responses are **byte-identical** across repeats.
- **SQL-only**: Filtering/paging done with **WHERE / LIMIT / OFFSET**; evidence uses **DISTINCT + ORDER BY** (no JS `.slice`/`.filter` on rows).
- **Prepared statements**: Hot queries use `prepare()` with **bind/reset** reuse (behavior unchanged).
- **Canonical metadata**: Responses include `dataset_version` and **BLAKE3(canonical_request_bytes)** as `query_hash`.
- **Validation & types**: Inputs validated (400 on invalid shapes); no `as any`; typed DTOs; ESM internals use **`.js`**; no deep imports.

## What stayed (invariants)
- Storage strictly **SQLite** (via sql.js); no networked DB.
- Tests are **hermetic & parallel-safe** (no runtime FS/network writes).
- At least **10 distinct** evidence items per response.
- No new runtime deps beyond sql.js; repo blocks `*.db`, `*.sqlite*`, `*.db-wal`, `*.db-shm`.

## Tests / tripwires
- **Prepared vs direct equivalence** → byte-identical JSON.
- **SQL-only enforcement** → static scan forbids `.slice(`/`.filter(`) on DB rows in prod paths.
- **Injection guard** → values like `"' OR 1=1 --"` return the same results when bound.
- **Paging boundaries** → `limit=0`, large `offset`, invalid shapes → deterministic (400 on invalid), stable across 3 runs.
- **Storage proof** → only `sql.js` imported; no native sqlite bindings.
- **Determinism loop** → core tests repeated 3× with identical outputs.

## Rationale in one line
Hermetic **sql.js + parameterized/prepared SQL + canonical metadata** yields a deterministic, portable adapter that’s safe under concurrency and CI.

## Open follow-ups (non-blocking)
- Scripted **seed regeneration** from source data (deterministic).
- **Indexing** review for large datasets (perf without changing results).
- Expand **error contract** docs/snapshots (all 4xx/5xx shapes).
- Optional metrics hooks (off by default) to time prepared vs direct.
- Tiny README in `services/claims-api-ts` describing fixtures and guarantees.
