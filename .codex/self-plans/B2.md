# Plan for B2

## Steps
1. Create a proof logging module in TS that collects proof tags when `DEV_PROOFS=1` and expose emit/flush helpers.
2. Update TS VM interpreter to emit Transport tags for lens ops, Refutation tags on ASSERT failures, Witness and Normalization tags after run, and Conservativity tags on CALL errors.
3. Export the new proof module and adjust tests to verify tags appear only when `DEV_PROOFS=1`.
4. Implement analogous proof logging in Rust: global log with `emit` and `flush`, gated by `DEV_PROOFS` env var.
5. Update Rust VM interpreter to emit tags for lens ops, asserts, calls, and final witness/normalization, mirroring TS behavior.
6. Add Rust tests ensuring tags are emitted only in dev mode.
7. Run `pnpm -C packages/tf-lang-l0-ts test` and `cargo test --manifest-path packages/tf-lang-l0-rs/Cargo.toml` to verify.
8. Update `.codex/JOURNAL.md` with a new B2 entry; add a lesson if a new general rule emerges.

## Tests
- `pnpm -C packages/tf-lang-l0-ts test`
- `cargo test --manifest-path packages/tf-lang-l0-rs/Cargo.toml`

## Risks
- Environment variable may leak between tests; ensure logs are flushed and variables reset.
- Synchronizing tag structures across runtimes might be inconsistent.
- Adding dependency `once_cell` for Rust logging could impact build.

## Definition of Done
- Proof tags emitted in both TS and Rust VMs only when `DEV_PROOFS=1`.
- Tests cover presence and absence of tags.
- Journal updated and repository tests pass.

## Plan 2025-09-12
1. Add `.js` extension to `packages/tf-lang-l0-ts/src/proof/index.ts` import.
2. Replace module-level proof log with `AsyncLocalStorage` and expose `withProofLog` wrapper.
3. Wrap test helper `withEnv` with `withProofLog` for isolated logs and add `.js` extensions in tests.
4. Implement byte-wise comparison in TS VM interpreter and remove `as any` cast using `as const`.
5. Swap Rust `static mut` cache for atomic `AtomicU8` implementation.
6. Avoid unnecessary clone of `final_state` in Rust VM interpreter.
7. Strengthen TS and Rust cache tests with post-reset assertions.
8. Run `pnpm -C packages/tf-lang-l0-ts test` and `cargo test --manifest-path packages/tf-lang-l0-rs/Cargo.toml`.
9. Append B2-polish3 entry to `.codex/JOURNAL.md`.

## Tests
- `pnpm -C packages/tf-lang-l0-ts test`
- `cargo test --manifest-path packages/tf-lang-l0-rs/Cargo.toml`

## Risks
- AsyncLocalStorage usage may not propagate in all async flows.
- Atomic env cache must correctly handle concurrent init.
- Test expectations may need updates after refactors.

## Definition of Done
- All reviewer comments addressed.
- Tests pass and journal updated.
