# Plan for B2

## Steps
1. Create a proof logging module in TS that collects proof tags when `DEV_PROOFS=1` and expose emit/flush helpers.
2. Update TS VM interpreter to emit Transport tags for lens ops, Refutation tags on ASSERT failures, Witness and Normalization tags after run, and Conservativity tags on CALL errors.
3. Export the new proof module and adjust tests to verify tags appear only when `DEV_PROOFS=1`.
4. Implement analogous proof logging in Rust: global log with `emit` and `flush`, gated by `DEV_PROOFS` env var.
5. Update Rust VM interpreter to emit tags for lens ops, asserts, calls, and final witness/normalization, mirroring TS behavior.
6. Add Rust tests ensuring tags are emitted only in dev mode.
7. Run `pnpm -C packages/tf-lang-l0-ts test` and `cargo test --manifest-path packages/tf-lang-l0-rs/Cargo.toml` to verify.
8. Update `.codex/JOURNAL.md` with a new B2 entry; add a lesson if a new general rule emerges.

## Tests
- `pnpm -C packages/tf-lang-l0-ts test`
- `cargo test --manifest-path packages/tf-lang-l0-rs/Cargo.toml`

## Risks
- Environment variable may leak between tests; ensure logs are flushed and variables reset.
- Synchronizing tag structures across runtimes might be inconsistent.
- Adding dependency `once_cell` for Rust logging could impact build.

## Definition of Done
- Proof tags emitted in both TS and Rust VMs only when `DEV_PROOFS=1`.
- Tests cover presence and absence of tags.
- Journal updated and repository tests pass.

# Plan for B2 reboot

## Steps
1. Cache `DEV_PROOFS` flag in TS proof module; add `resetDevProofsForTest` to clear cache and log.
2. Replace TS `emit` to early exit when flag disabled; ensure no extra allocations when disabled.
3. Implement identical caching in Rust using `OnceLock` and thread-local log; add `reset_for_test`.
4. Update TS and Rust tests for enable/disable, caching semantics, reset, and cross-runtime parity using shared vector.
5. Add `CHANGES.md`, `B2-COMPLIANCE.md`, and update `.codex/JOURNAL.md`.

## Tests
- `pnpm -C packages/tf-lang-l0-ts test`
- `pnpm -C packages/tf-lang-l0-ts build && node --input-type=module -e "import('./dist/index.js')"`
- `cargo test --manifest-path packages/tf-lang-l0-rs/Cargo.toml`

## Risks
- Incorrect caching could miss env changes, leading to flaky tests.
- Thread-local log implementation errors could drop tags.
- ESM build may fail if imports lack `.js` extension.

## Definition of Done
- Proof tags emitted only when `DEV_PROOFS=1` with cached flag and reset hook.
- TS and Rust emit identical tags for shared vector; tests deterministic.
- ESM build loads without module resolution errors.
