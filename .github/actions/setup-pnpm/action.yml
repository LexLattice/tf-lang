# .github/actions/setup-pnpm/action.yml
name: setup-pnpm
description: Setup Node + pnpm (reads pinned version from package.json:packageManager), optionally install
inputs:
  node-version:
    description: Node.js version
    required: false
    default: '20'
  install:
    description: Run pnpm install after setup
    required: false
    default: 'true'
  frozen:
    description: Use --frozen-lockfile when installing
    required: false
    default: 'true'

runs:
  using: composite
  steps:
    # 1) Install pnpm FIRST (reads version from package.json's packageManager)
    - uses: pnpm/action-setup@v4
      with:
        run_install: false
        # optional: package_json_file: package.json

    # 2) Then setup Node and enable pnpm cache
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: pnpm
        cache-dependency-path: |
          pnpm-lock.yaml
          **/pnpm-lock.yaml

    # 3) Sanity check
    - shell: bash
      run: pnpm -v

    # 4) Optional install
    - if: ${{ inputs.install == 'true' }}
      shell: bash
      run: |
        if [[ "${{ inputs.frozen }}" == "true" ]]; then
          pnpm install --frozen-lockfile
        else
          pnpm install
        fi
