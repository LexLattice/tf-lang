# PR #87 — F2 pass‑2: lowercase GHCR, digest summary, reproducibility knob

- PR: [#87](https://github.com/LexLattice/tf-lang/pull/87)

## Brief (verbatim)
```
# F2 — Pass 2 — Run B

## Summary (≤ 3 bullets)
- Lowercased GHCR repository path and added reproducibility env knob for deterministic builds.
- Recorded both build digests and pushed digest in step summary while preserving main-only pushes.
- Deduplicated Dockerfile base image digest via ARG; runtime unchanged.

## End Goal → Evidence
- EG-1: GHCR tags use lowercased repo path and push only on main【F:.github/workflows/ci.yml†L44-L72】
- EG-2: Double-build digests compared and written to step summary with pushed digest on main【F:.github/workflows/ci.yml†L88-L98】

## Blockers honored (must all be ✅)
- B-1: ✅ Tags `0.2` and `latest` only; push guarded by main branch check【F:.github/workflows/ci.yml†L55-L72】
- B-2: ✅ Dockerfile reuses pinned base image digest without altering runtime semantics【F:services/claims-api-ts/Dockerfile†L3-L8】【F:services/claims-api-ts/Dockerfile†L33-L36】

## Determinism & Hygiene
- Byte-identical outputs across repeats: ✅
- SQL-only / no JS slicing (if applicable): ✅
- ESM `.js`, no deep imports, no `as any`: ✅

## Self-review checklist (must be all ✅)
- [x] Production code changed (tests only ≠ pass)
- [x] Inputs validated; 4xx on bad shapes
- [x] No new runtime deps (unless allowed)
- [x] CI gauntlet green

## Delta since previous pass (≤ 5 bullets)
- Added REGISTRY, REPO_LC, and SOURCE_DATE_EPOCH env to image job.
- Summarized build and push digests in $GITHUB_STEP_SUMMARY.
- Deduped Node base image digest via ARG.

```yaml
review_focus:
  end_goal:
    - Publish container images to GHCR tagged 0.2 and latest from main only
    - PR builds build images without pushing
    - Rebuilding the same commit yields identical digests; summary records both builds and pushed digest
  blockers:
    - No kernel/tag schema changes from pass 1
    - No per-call locks, unsafe, or TypeScript as any
    - ESM internal imports include ".js"
    - Tests run in parallel without state bleed; outputs deterministic
    - Images tagged 0.2 and latest with lowercase repo path
    - Push to GHCR occurs only on main
  acceptance:
    - Workflow tags use ghcr.io/${{ env.REPO_LC }}/claims-api-ts
    - Step summary lists both build digests and final pushed digest
    - Build job env sets SOURCE_DATE_EPOCH: 0
    - CI fails if the two build digests differ
    - Service code and tests remain unchanged
```
```

## Summary (5 bullets)
- Lowercases GHCR repo path; tags `0.2` and `latest` on main only.
- Compares digests from two builds; records both and pushed digest in summary.
- Adds reproducibility knob (`SOURCE_DATE_EPOCH=0`) in image job env.
- Dedupes base image digest via ARG; runtime unchanged.
- CI/ops only; no functional changes to API or kernels.

