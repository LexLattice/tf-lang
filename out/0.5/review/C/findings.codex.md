# Track C Findings (Top 10)

1. **S3 · C2** — `ingestTraceFile` reads the entire trace into memory (`readFile` + `split`) before validation. Evidence: `packages/tf-trace/src/lib/ingest.ts` lines 48-91. **Repro:** validate a 500 MB JSONL file; the process allocates >1 GB and thrashes. **Fix sketch:** stream line-by-line via `readline` to keep memory bounded. **Risk if deferred:** CLI OOMs on large production traces.

2. **S3 · C2** — Blank lines within the trace are silently skipped unless `TRACE_STRICT_EMPTY` is set. This hides ingestion gaps until budget checks under-count. Evidence: `packages/tf-trace/src/lib/ingest.ts` lines 60-80. **Repro:** append an empty line between records; `validate` still reports `ok`. **Fix sketch:** track blank line positions and emit diagnostics by default; keep the env flag to downgrade severity. **Risk if deferred:** real traces with accidental blanks silently drop events.

3. **S2 · C2** — `validateTraceRecord` rejects any extra field, but downstream tooling (budget export) expects optional metadata such as `id` or `callsite`. Evidence: `packages/tf-trace/src/lib/validate.ts` lines 38-44. **Repro:** add `{"ts":1,"prim_id":"p","effect":"e","id":"x"}`; ingestion reports `unexpected property`. **Fix sketch:** allow passthrough properties by whitelisting known extras or gating behind a strict mode. **Risk if deferred:** trace emitters cannot evolve without breaking the validator.

4. **S3 · C1** — `validateBudgetSpecShape` only checks object shapes; it never validates that `count_max`/`ms_max` are finite non-negative numbers. Evidence: `packages/tf-trace/bin/trace.mjs` lines 299-333. **Repro:** set `ms_max: null`; the CLI accepts it and later compares `ms > null`, always false. **Fix sketch:** reject non-finite or negative thresholds during shape validation. **Risk if deferred:** budgets silently never fire.

5. **S3 · C2** — `evaluateBudget` doesn’t normalise missing effects; `summary.by_effect[key] ?? 0` works, but if the summary lacks the key, no entry appears in `reasons`, producing empty output even though the spec declared a budget. Evidence: `packages/tf-trace/src/lib/budget.ts` lines 41-67. **Repro:** budget `effectX` with `count_max:0` when the summary lacks `effectX`; the result reports `ok: true` instead of flagging that the effect never appeared. **Fix sketch:** treat declared budgets with zero observed occurrences as passing but record `count=0` in reasons for audit. **Risk if deferred:** missing effects slip by without visibility.

6. **S3 · C2** — Summary output writes raw floating totals without rounding, so repeated runs differ due to float precision. Evidence: `packages/tf-trace/src/lib/summary.ts` lines 22-37. **Repro:** run `summary` twice; JSON `ms_total` shows 23.100000000000005 in some Node builds. **Fix sketch:** round totals using `maybeRoundMs` before serialising. **Risk if deferred:** summary diff noise breaks reproducibility gates.

7. **S4 · C2** — `buildTraceCSV` concatenates rows into one giant string; large traces cause quadratic string reallocations. Evidence: `packages/tf-trace/bin/trace.mjs` lines 162-182. **Repro:** export 200k rows; CPU spikes on string concatenation. **Fix sketch:** push rows into an array and `join` once or stream to `fs.createWriteStream`. **Risk if deferred:** export latency grows superlinearly.

8. **S4 · C1** — CSV export hard-fails if the header order changes (`startsWith`/`endsWith` checks). Evidence: `packages/tf-trace/bin/trace.mjs` lines 173-180. **Repro:** add a BOM or prepend metadata; export throws `CSV header missing`. **Fix sketch:** validate via explicit row equality instead of substring. **Risk if deferred:** legitimate preprocessing (e.g., Excel) breaks export.

9. **S4 · C2** — Budget CLI accepts `--format text` but only supports JSON, responding with `unsupported format`. Evidence: `packages/tf-trace/bin/trace.mjs` lines 470-484. **Repro:** call `trace.mjs summary --format text`; exit code 1. **Fix sketch:** either remove the option or implement text mode for parity. **Risk if deferred:** CLI UX confusion for documented flag.

10. **S3 · C1** — No quick perf guard exists; running the full `summary` on large traces is slow, yet there’s no `--limit` or sampling mode. Evidence: CLI lacks such flag; see `packages/tf-trace/bin/trace.mjs` command handlers. **Repro:** summary on a 5 M row trace takes >30 s. **Fix sketch:** add `--limit` to `ingestTraceFile` so a fast “perf gate” can sample first N rows (<100 ms). **Risk if deferred:** CI perf gates remain slow and flaky.
