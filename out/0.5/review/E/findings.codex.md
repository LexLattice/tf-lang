# Track E Findings (Top 10)

1. **S2 · C2** — `emitFlowEquivalence` can’t reason about `idempotent:write-by-key` because `OPERATION_DEFINITIONS` lacks a `'write-by-key'` entry, yet the law introduces symbol `W`. Evidence: `packages/tf-l0-proofs/src/smt-laws.mjs` lines 31-56. **Repro:** call `emitFlowEquivalence(['write-by-key'], ['write-by-key'], ['idempotent:write-by-key'])`; it throws `Unknown operation: write-by-key`. **Fix sketch:** add the operation definition or drop the law. **Risk if deferred:** rewrite proofs for storage primitives remain unverified.

2. **S1 · C2** — The `idempotent:write-by-key` law encodes only `(assert (not (= twice once)))` without axioms enforcing equality, so SMT queries conclude the negation is satisfiable. Evidence: `packages/tf-l0-proofs/src/smt-laws.mjs` lines 31-42. **Repro:** run the generated script through Z3; it returns `sat`. **Fix sketch:** supply axioms describing the storage semantics (e.g., `(assert (= (W u k ik (W u k ik v)) (W u k ik v)))`). **Risk if deferred:** optimizer trusts a “law” that is actually false.

3. **S2 · C2** — `normalizeLawList` preserves the caller’s casing, but `canonicalLawName` elsewhere expects trimmed case-sensitive names. Passing `Idempotent:Hash` fails silently. Evidence: `packages/tf-l0-proofs/src/smt-laws.mjs` lines 222-244. **Repro:** `emitLaw('Idempotent:Hash')` throws `Unknown law`. **Fix sketch:** lower-case entries inside `normalizeLawList`. **Risk if deferred:** callers must guess exact casing, increasing integration bugs.

4. **S3 · C2** — `normalizeOperation` strips everything after the first `(` but does not handle namespace prefixes (`tf:network/publish@1`). Evidence: `packages/tf-l0-proofs/src/smt-laws.mjs` lines 202-218. **Repro:** normalize `tf:network/publish@1`; result is `tf:network/publish@1`, which has `/` and `@` not in `OPERATION_DEFINITIONS`. **Fix sketch:** split on `/` and `@` to extract the primitive name. **Risk if deferred:** proof generation fails for fully-qualified primitives.

5. **S3 · C1** — `emitFlowEquivalence` collects sorts from both flows but never deduplicates functions before emission, so duplicate declarations appear when two laws share a function. Evidence: `packages/tf-l0-proofs/src/smt-laws.mjs` lines 90-140. **Repro:** request two laws using `H`; the SMT file redeclares `H` twice. **Fix sketch:** deduplicate via `Set` before `emitFunctions`. **Risk if deferred:** solvers reject the script with `symbol already declared`.

6. **S3 · C2** — `emitFlowEquivalence` assumes flows have matching arity and throws immediately when start/end sorts differ. For counterexample searches you want the solver to report unsat, not the JS wrapper to throw. Evidence: `packages/tf-l0-proofs/src/smt-laws.mjs` lines 90-104. **Repro:** pass mismatched flows; exception thrown. **Fix sketch:** encode the mismatch as an assertion (e.g., `(assert true)` but mark `ok: false`) so batch tooling can continue. **Risk if deferred:** automated proof runs abort on the first mismatch.

7. **S3 · C1** — `collectSorts`/`collectFunctions` throw on unknown entries, but there’s no guard before calling `emitLaw`; a typo in the catalog halts the whole pipeline. Evidence: `packages/tf-l0-proofs/src/smt-laws.mjs` lines 246-273. **Fix sketch:** validate law definitions on load and surface actionable errors. **Risk if deferred:** runtime crashes whenever new laws are drafted.

8. **S4 · C2** — `listLawNames` derives from object keys; object insertion order in Node follows definition order, so adding a new law can reshuffle the sorted list if the key casing differs. Evidence: `packages/tf-l0-proofs/src/smt-laws.mjs` lines 17-48 & 58-60. **Fix sketch:** store law metadata in an array to guarantee deterministic ordering. **Risk if deferred:** law ordering drifts between releases, breaking snapshot tests.

9. **S4 · C1** — `emitLaw` appends `(check-sat)` but never requests `(get-model)` on failure, complicating debugging. Evidence: `packages/tf-l0-proofs/src/smt-laws.mjs` lines 62-75. **Fix sketch:** add a flag to print witnesses via `(get-model)` or `(get-proof)` when `RELEASE_VERBOSE` is set. **Risk if deferred:** proof authoring remains painful.

10. **S4 · C1** — There are no automated tests ensuring that the emitted SMT is unsatisfiable for proven laws; `packages/tf-opt/lib/tests` exercise optimizations only. **Fix sketch:** add a smoke test invoking Z3 (or mock) on each law. **Risk if deferred:** regressions in proof encodings land unnoticed.
