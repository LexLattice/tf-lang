node: E1-E2-Proofs

phases:
  cp1_linkage:
    rules:
      - used_laws_present
      - no_missing_laws
      - smt_law_schema_microtest

  cp2_solver_gate:
    rules:
      - z3_optional_small

rules:
  used_laws_present:
    kind: process
    cmd: node packages/tf-opt/bin/opt.mjs --ir out/0.4/ir/signing.ir.json --emit-used-laws out/0.5/proofs/used-laws.json
    expect: { code: 0, contains: '"used_laws":' }

  no_missing_laws:
    kind: process
    cmd: node scripts/proofs/ci-gate.mjs --check-used out/0.5/proofs/used-laws.json
    expect: { code: 0, contains: '"missing": []' }

  smt_law_schema_microtest:
    kind: process
    cmd: node --eval "import('./packages/tf-l0-proofs/src/smt-laws.microtest.mjs')"
    expect: { code: 0, contains: 'smt-laws validation micro-test passed' }

  z3_optional_small:
    kind: process
    cmd: node scripts/proofs/ci-gate.mjs --small samples/e1/small_flow.tf
    expect: { code: 0, contains: '"ok": true' }
